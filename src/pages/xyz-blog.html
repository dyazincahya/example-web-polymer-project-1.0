<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="../styles/style-blog.html">
<dom-module id="xyz-blog">
    <template>
        <style include="style-blog"></style>

        <div class="altar">
            <div class="altar-content">
                <h1><iron-icon icon="icons:folder-open"></iron-icon> All my blog</h1>
                <vaadin-combo-box
                    on-change="_comboSelected"
                    label="choose one of blog"
                    item-label-path="name"
                    item-value-path="id"
                    items="[[dataListBlog]]"></vaadin-combo-box>
                <pre><iron-icon icon="icons:help-outline"></iron-icon> blog id selected : [[dataSelectedBlog]]</pre>              
            </div>
        </div>

        <div class="alt">
            <h1><iron-icon icon="icons:bookmark-border"></iron-icon> Latest post &amp; draft</h1>
        </div>

        <template is="dom-repeat" items="[[dataEntry]]">
            <div class="card">
                <h1>
                    <iron-icon icon="[[item.attr.icon]]"></iron-icon>
                    <a href="[[item.url]]" target="[[item.attr.hrefTarget]]" class="url-post">[[item.title]]</a>
                </h1>
                <p>
                    <iron-icon icon="icons:alarm"></iron-icon> [[item.published]]
                    <iron-icon icon="icons:update"></iron-icon> [[item.updated]]
                </p>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'xyz-blog',
            properties: {
                dataEntry: {
                    type: Array,
                    value: function(e){
                        console.log(e);
                        var totalRow = 21,
                            arrContainer = [];

                        for(var i=0; i<=totalRow; i++){
                            arrContainer.push(
                                { 
                                    "title" : '', 
                                    "url"   : '', 
                                    "published" : '', 
                                    "updated" : '',
                                    "attr" : {
                                        "icon" : '', 
                                        "hrefTarget" : ''
                                    }
                                }
                            );
                        }
                        return arrContainer;
                    }
                },
                dataListBlog: {
                    type: Array,
                    value: [
                        { "id" : '2556722185382757751', "name" : 'www.kang-cahya.com' },
                        { "id" : '3192608950474468796', "name" : 'copas.kang-cahya.com' },
                        { "id" : '6335012301038944480', "name" : 'kiliah.kang-cahya.com' },
                        { "id" : '1415152289005962738', "name" : 'perjalanan.kang-cahya.com' },
                        { "id" : '1242185788910194006', "name" : 'tv.kang-cahya.com' },
                    ]
                },
                dataSelectedBlog: {
                    type: String,
                    value: 'none'
                },
                dataTotalRow: {
                    type: Number,
                    value: 20
                }
            },
            _returnTotalRow: function(){
                return this.dataTotalRow;
            },
            _comboSelected: function(e){
                if(e.target.value == "" || e.target.value == null){
                    this.set("dataSelectedBlog", "none");
                }else{
                    this.set("dataSelectedBlog", e.target.value);
                    this._runAjax(this.dataSelectedBlog);
                }
            },
            _ifNull: function(data){
                if(data == null || data == "" || data == "null"){
                    return "empty text!";
                }else{
                    return data;
                }
            },
            _runAjax: function(id="2556722185382757751"){
                var me = this;
                $.ajax({
                    type: "GET",
                    url: "https://www.blogger.com/feeds/"+id+"/posts/default",
                    dataType: "jsonp",
                    success: function(xml) {
                        var totalEl = $(xml).find('entry').length;
                        if(totalEl > 20){

                        }
                        // console.log(totalEl);
                        $(xml).find('entry').each(function(i, e){
                            var title = $(e).find('title').text();
                            var urlPostRaw = $(e).find('link').filter(function( index ) { return index; });
                            var urlPost = $(urlPostRaw).attr("href");
                            var published = $(e).find('published').text();
                            var updated = $(e).find('updated').text();
                            
                            if(urlPostRaw.length == 4){
                                me.set('dataEntry.'+i+'.title', me._ifNull(title));
                                me.set('dataEntry.'+i+'.url', urlPost);
                                me.set('dataEntry.'+i+'.published', published);
                                me.set('dataEntry.'+i+'.updated', updated);

                                me.set('dataEntry.'+i+'.attr.icon', "icons:done-all");
                                me.set('dataEntry.'+i+'.attr.hrefTarget', "_blank");
                            }else{
                                me.set('dataEntry.'+i+'.title', me._ifNull(title));
                                me.set('dataEntry.'+i+'.url', "#thisDraft");
                                me.set('dataEntry.'+i+'.published', published);
                                me.set('dataEntry.'+i+'.updated', updated);

                                me.set('dataEntry.'+i+'.attr.icon', "icons:lock-outline");
                                me.set('dataEntry.'+i+'.attr.hrefTarget', "_self");
                            }
                        });
                    }
                });
            },
            ready : function(){
                this._runAjax();
            }
        });
    </script>
</dom-module>
